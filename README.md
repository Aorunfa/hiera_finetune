# 说明
本项目在原hiera仓库的基础上，增加mae和下游任务训练代码
> 模型代码来源于[hiera](https://github.com/facebookresearch/hiera)
- [x] <input type="checkbox" disabled checked> 数据预处理
- [x] <input type="checkbox" disabled checked> mae训练
- [x] <input type="checkbox" disabled checked> hiera训练
- [x] <input type="checkbox" disabled > 单机多卡训练

# 快速开始
## 环境安装
```bash
git clone https://github.com/Aorunfa/hiera_finetune.git
conda create -n hiera python=3.10
conda activate hiera
cd ./hiera_finetune
pip install -r requirements.txt
```

## 数据准备
### * 微调数据集
使用kinetics-400的一个小微数据集快速验证训练过程，从[tiny-kinetics-400](https://github.com/Tramac/tiny-kinetics-400)下载数据放置于./dataset目录。需要注意的是，为了快速验证训练效果，验证集取训练视频平移40帧的数据跨度作为输入，每个视频30ps, 暂且可以认为训练集约验证集分布相同
确保目录结构如下
```text
dataset/tiny-kinetics-400
├── annotations
│   ├── tiny_train.csv
│   └── tiny_val.csv
├── data_30fps_frames
│   ├── abseiling
│   │   ├── _4YTwq0-73Y_000044_000054
│   │   │   ├── frame_00001.jpg
│   │   │   └── ...
│   │   └── ...
│   ├── air_drumming
│   │   ├── ...
│   └── ...
├──
```
### * MAE预训练数据集
选择imagenet1k的验证数据集作为训练数据和验证数据，从[imagenet_val](https://modelscope.cn/datasets/tany0699/imagenet_val)下载数据, 划分训练集和验证集，将路劲替换进`train_mae.py`的Config类的train_dir和val_dir

## 单卡训练
### * 微调
修改`train_ft.py`的Config类文件，启动单卡训练脚本，训练过程指标将存储在`record/metric.csv`
```bash
python ./train_ft.py
```
### * 预训练MAE
修改`train_mae.py`的Config类文件，启动单卡训练脚本，训练过程指标将存储在`record/metric_mae.csv`
```bash
python ./train_mae.py
```

## 单机多卡训练
```bash
python -m torch.distributed.run --nproc_per_node 4 --nnodes 1 ./train_ft_dist.py
python -m torch.distributed.run --nproc_per_node 4 --nnodes 1 ./train_mae_dist.py
```

# 训练指标说明
# * 微调
使用准确率作为分类指标
time	step	loss	lr	acc
01-08 04:13	1000	4.918361663818359	0.0009462214657359972	0.0175
01-08 04:18	2000	3.6841750144958496	0.000879885201735999	0.1025
01-08 04:23	3000	3.2966036796569824	0.0008135489377360007	0.1225
01-08 04:28	4000	3.5611820220947266	0.0007472126737360025	0.065
01-08 04:34	5000	3.2286839485168457	0.0006808764097360042	0.1325
01-08 04:39	6000	2.9820339679718018	0.000614540145736006	0.1525
01-08 04:44	7000	2.9239964485168457	0.0005482038817360077	0.1475
01-08 04:49	8000	2.762258768081665	0.00048186761773600934	0.15
01-08 04:55	9000	2.672461986541748	0.00041553135373601	0.1375
01-08 05:00	10000	2.6116182804107666	0.00034919508973601176	0.1075
01-08 05:05	11000	2.5943074226379395	0.0002828588257360135	0.15
01-08 05:10	12000	2.5531375408172607	0.0002165225617360131	0.1575
01-08 05:15	13000	2.5214028358459473	0.00015018629773601113	0.1525
01-08 05:21	14000	2.498117208480835	8.385003373600762e-05	0.1525
01-08 05:26	15000	2.4847917556762695	1.751376973600173e-05	0.1475
01-08 05:44	1000	4.636990070343018	9.462214657359948e-05	0.255
01-08 05:49	2000	3.5034546852111816	8.798852017359894e-05	0.5
01-08 05:55	3000	2.5131144523620605	8.135489377359827e-05	0.6475
01-08 06:00	4000	1.6877026557922363	7.472126737359751e-05	0.6975
01-08 06:05	5000	0.955906867980957	6.808764097359687e-05	0.765
01-08 06:10	6000	0.5556598901748657	6.145401457359607e-05	0.7975
01-08 06:15	7000	0.29849785566329956	5.4820388173596524e-05	0.825
01-08 06:21	8000	0.19516170024871826	4.818676177359735e-05	0.835
01-08 06:26	9000	0.11390696465969086	4.155313537359847e-05	0.84
01-08 06:31	10000	0.06835649907588959	3.491950897359977e-05	0.8625
01-08 06:36	11000	0.04221341386437416	2.8285882573600744e-05	0.8625
01-08 06:42	12000	0.029331762343645096	2.1652256173600584e-05	0.8525
01-08 06:47	13000	0.018021591007709503	1.5018629773600385e-05	0.8575
01-08 06:52	14000	0.013958354480564594	8.38500337360022e-06	0.855
01-08 06:57	15000	0.011795985512435436	1.7513769736000547e-06	0.8575

# * 预训练mae
mae预训练采用验证集的loss作为检测指标，loss使用MSE度量mask区域真实向量分布与预测向量分布的差异
time	step	loss_train	lr	loss_val
01-08 05:08	1000	0.8491292595863342	9.645092821113854e-05	0.9408512711524963
01-08 05:10	2000	0.8246685862541199	9.225243048961906e-05	0.9375044107437134
01-08 05:12	3000	0.8363493084907532	8.805393276809942e-05	0.9378584325313568
01-08 05:14	4000	0.8017708659172058	8.385543504657979e-05	0.9273825287818909
01-08 05:16	5000	0.7806540727615356	7.965693732506016e-05	0.9287621974945068
01-08 05:18	6000	0.8066259026527405	7.54584396035405e-05	0.9355646967887878
01-08 05:20	7000	0.7953037023544312	7.125994188202066e-05	0.8915745913982391
01-08 05:22	8000	0.829845130443573	6.706144416050062e-05	0.869077205657959
01-08 05:24	9000	0.7385718822479248	6.286294643898065e-05	0.8655818104743958
01-08 05:26	10000	0.7809921503067017	5.866444871746139e-05	0.8592422902584076
01-08 05:28	11000	0.7477623224258423	5.446595099594307e-05	0.8587217032909393
01-08 05:30	12000	0.7348881363868713	5.026745327442482e-05	0.850330114364624
01-08 05:32	13000	0.7127718925476074	4.606895555290675e-05	0.8489561975002289
01-08 05:34	14000	0.7113237977027893	4.187045783138877e-05	0.8466142416000366
01-08 05:36	15000	0.7542316317558289	3.767196010987094e-05	0.8350155055522919
01-08 05:38	16000	0.7066752314567566	3.347346238835335e-05	0.8406100869178772




